<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tapnow Studio</title>
</head>

<body style="margin: 0; padding: 0; background-color: #09090b;">
    <div id="root"></div>
    <script>
        (function () {
            if (window.__APP_BOOT_GUARD__) return;
            window.__APP_BOOT_GUARD__ = true;
            window.__APP_BOOTED__ = false;
            window.__APP_ERRORS__ = window.__APP_ERRORS__ || [];
            var MAX_ERRORS = 50;
            var BOOT_TIMEOUT_MS = 5000;
            var recordError = function (error, meta) {
                var entry = {
                    time: new Date().toISOString(),
                    message: (error && error.message) ? error.message : String(error || 'UnknownError'),
                    stack: (error && error.stack) ? error.stack : '',
                    meta: meta || {}
                };
                window.__APP_ERRORS__.push(entry);
                if (window.__APP_ERRORS__.length > MAX_ERRORS) {
                    window.__APP_ERRORS__.shift();
                }
                return entry;
            };
            var buildPayload = function (error, meta) {
                var latest = recordError(error, meta || {});
                return JSON.stringify({ latest: latest, errors: window.__APP_ERRORS__ }, null, 2);
            };
            var copyText = function (text) {
                if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
                    return navigator.clipboard.writeText(text).catch(function () { });
                }
                try {
                    var textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.setAttribute('readonly', '');
                    textarea.style.position = 'absolute';
                    textarea.style.left = '-9999px';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                } catch (e) { }
            };
            var renderFallback = function (error, meta) {
                var root = document.getElementById('root');
                if (!root) return;
                var payload = buildPayload(error, meta || {});
                root.innerHTML =
                    '<div style="position:fixed;inset:0;background:#0b0b0c;color:#f3f3f3;display:flex;align-items:center;justify-content:center;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;">' +
                    '<div style="width:min(900px,92vw);background:#141416;border:1px solid #2a2a2d;border-radius:12px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,0.4);">' +
                    '<div style="font-size:18px;font-weight:700;margin-bottom:8px;">Tapnow 启动失败</div>' +
                    '<div style="font-size:12px;color:#b6b6c2;margin-bottom:16px;">应用启动过程中发生异常，已启用黑屏保护。</div>' +
                    '<div style="background:#0f0f12;border:1px solid #2a2a2d;border-radius:8px;padding:12px;font-size:12px;white-space:pre-wrap;max-height:240px;overflow:auto;">' +
                    payload.replace(/</g, '&lt;') +
                    '</div>' +
                    '<div style="display:flex;gap:10px;margin-top:16px;">' +
                    '<button id="tapnow-boot-reload" style="background:#2563eb;color:#fff;border:none;border-radius:8px;padding:8px 12px;font-size:12px;cursor:pointer;">重新加载</button>' +
                    '<button id="tapnow-boot-copy" style="background:#27272a;color:#fff;border:1px solid #3f3f46;border-radius:8px;padding:8px 12px;font-size:12px;cursor:pointer;">复制错误详情</button>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
                var reloadBtn = document.getElementById('tapnow-boot-reload');
                var copyBtn = document.getElementById('tapnow-boot-copy');
                if (reloadBtn) reloadBtn.onclick = function () { window.location.reload(); };
                if (copyBtn) copyBtn.onclick = function () { copyText(payload); };
            };
            window.addEventListener('error', function (event) {
                recordError(event && event.error ? event.error : event && event.message, {
                    type: 'window_error',
                    source: event && event.filename,
                    lineno: event && event.lineno,
                    colno: event && event.colno
                });
            });
            window.addEventListener('unhandledrejection', function (event) {
                recordError(event && event.reason ? event.reason : 'UnhandledRejection', { type: 'unhandledrejection' });
            });
            window.setTimeout(function () {
                if (!window.__APP_BOOTED__) {
                    renderFallback(new Error('APP_BOOT_TIMEOUT'), { type: 'boot_timeout' });
                }
            }, BOOT_TIMEOUT_MS);
        })();
    </script>
    <script type="module" src="/src/main.jsx"></script>
</body>

</html>
